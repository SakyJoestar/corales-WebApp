<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coral App – Marcado de Puntos</title>

<style>
body { font-family: Arial, sans-serif; margin: 18px; background:#fafafa; }
h2, h3 { margin-top: 0; }

.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 14px;
}

.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

button {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #f3f3f3;
  cursor: pointer;
}

button:hover { background: #e9e9e9; }

input[type="number"] { width: 90px; }

.row {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  flex-wrap: wrap;
}

table {
  border-collapse: collapse;
  width: 520px;
  max-width: 100%;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px 8px;
}

th {
  background: #f0f0f0;
  text-align: left;
}

/* VISOR GRANDE */
#viewer {
  width: min(1200px, 98vw);
  height: 75vh;
  border: 1px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  background: #f7f7f7;
  cursor: grab;
}

#viewer img {
  position: absolute;
  left: 0;
  top: 0;
  transform-origin: 0 0;
  user-select: none;
  -webkit-user-drag: none;
}

#status {
  margin-top: 8px;
  font-size: 14px;
  font-weight: bold;
}

.help-text {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
}
</style>
</head>

<body>
<h2>Coral – Sistema de marcado de puntos</h2>

<div class="card">
  <h3>Procesar imagen</h3>

  <form id="imageForm" class="toolbar">
    <input type="file" id="imageFile" accept="image/*" required />

    <label>Modelo:</label>
    <select id="modelSelect"></select>

    <label>N puntos:</label>
    <input type="number" id="nPoints" value="100" min="1" max="5000" />

    <button type="submit">Procesar</button>
  </form>

  <div id="status"></div>
</div>

<div class="row">

  <div class="card">
    <h3>Imagen anotada</h3>

    <div class="toolbar" style="margin-bottom:8px;">
      <button id="resetViewBtn" type="button">Reiniciar vista</button>
      <button id="downloadImgBtn" type="button" disabled>Descargar imagen</button>
      <button id="downloadXlsxBtn" type="button" disabled>Descargar Excel</button>

      <div class="help-text" style="margin:0;">
        Click: zoom + | Shift+Click: zoom - | Arrastrar: mover | Rueda: zoom
      </div>
    </div>

    <div id="viewer">
      <img id="outImg" />
    </div>
  </div>

  <div class="card">
    <h3>Tabla de puntos (editable)</h3>
    <div class="help-text">Puedes cambiar la clase manualmente con el selector. Al editar, la conf se limpia y el origen pasa a “manual”.</div>
    <div id="table"></div>
  </div>

</div>

<script>
/* ===================== MODELOS ===================== */
const modelSelect = document.getElementById("modelSelect");
let AVAILABLE_CLASSES = [];

async function loadModels() {
  modelSelect.innerHTML = "";
  const res = await fetch("/models");
  const data = await res.json();

  if (!data.models || data.models.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(Sin modelos)";
    modelSelect.appendChild(opt);
    AVAILABLE_CLASSES = [];
    return;
  }

  // usar las clases que vienen del backend (asumimos iguales para todos)
  if (Array.isArray(data.models[0].classes)) {
    AVAILABLE_CLASSES = data.models[0].classes;
  }

  for (const m of data.models) {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.model_name || m.id;
    modelSelect.appendChild(opt);
  }
}
window.addEventListener("DOMContentLoaded", loadModels);


/* ===================== TABLA (EDITABLE) ===================== */
const tableDiv = document.getElementById("table");

function renderTable(points) {
  const classes = (AVAILABLE_CLASSES && AVAILABLE_CLASSES.length > 0)
    ? AVAILABLE_CLASSES
    : ["Algas","Coral","Otros organismos","Sustrato inerte","Tape","nan"];

  let html = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>x</th>
          <th>y</th>
          <th>clase</th>
          <th>conf</th>
          <th>origen</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (let i = 0; i < points.length; i++) {
    const p = points[i];
    const current = p.pred_label ?? "";

    const options = classes.map(c => {
      const sel = c === current ? "selected" : "";
      return `<option value="${c}" ${sel}>${c}</option>`;
    }).join("");

    html += `
      <tr data-idx="${i}">
        <td>${p.label ?? ""}</td>
        <td>${p.x}</td>
        <td>${p.y}</td>

        <td>
          <select class="classSelect">
            ${options}
          </select>
        </td>

        <td class="confCell">${p.confidence != null ? Number(p.confidence).toFixed(3) : ""}</td>
        <td class="srcCell">${p.source ?? "modelo"}</td>
      </tr>
    `;
  }

  html += "</tbody></table>";
  tableDiv.innerHTML = html;

  // Al cambiar clase, actualizar lastPoints
  tableDiv.querySelectorAll("select.classSelect").forEach(sel => {
    sel.addEventListener("change", (e) => {
      const tr = e.target.closest("tr");
      const idx = Number(tr.dataset.idx);
      const newClass = e.target.value;

      if (!Array.isArray(lastPoints) || idx < 0 || idx >= lastPoints.length) return;

      lastPoints[idx].pred_label = newClass;
      lastPoints[idx].source = "manual";

      // Al editar: limpiar confidence (opcional)
      lastPoints[idx].confidence = null;
      tr.querySelector(".confCell").textContent = "";
      tr.querySelector(".srcCell").textContent = "manual";
    });
  });
}


/* ===================== HELPERS NOMBRE ARCHIVO ===================== */
function getBaseName(filename) {
  const justName = (filename || "").split(/[/\\]/).pop();
  const dot = justName.lastIndexOf(".");
  return dot > 0 ? justName.slice(0, dot) : (justName || "imagen");
}

function sanitizeName(name) {
  return (name || "imagen").replace(/[<>:"/\\|?*\x00-\x1F]/g, "_").trim() || "imagen";
}


/* ===================== PROCESAR ===================== */
const imageForm = document.getElementById("imageForm");
const statusEl = document.getElementById("status");
const outImg = document.getElementById("outImg");

const downloadImgBtn = document.getElementById("downloadImgBtn");
const downloadXlsxBtn = document.getElementById("downloadXlsxBtn");

let lastImageBase64 = "";
let lastPoints = [];
let lastModelId = "";
let lastBaseName = "";

imageForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const fileObj = document.getElementById("imageFile").files[0];
  if (!fileObj) {
    statusEl.textContent = "Selecciona una imagen.";
    return;
  }

  const baseName = sanitizeName(getBaseName(fileObj.name));

  const fd = new FormData();
  fd.append("file", fileObj);
  fd.append("n", document.getElementById("nPoints").value);
  fd.append("model_id", modelSelect.value);

  // limpiar + deshabilitar
  statusEl.textContent = "Procesando imagen...";
  tableDiv.innerHTML = "";
  outImg.src = "";

  downloadImgBtn.disabled = true;
  downloadXlsxBtn.disabled = true;

  lastImageBase64 = "";
  lastPoints = [];
  lastModelId = "";
  lastBaseName = "";

  const res = await fetch("/process", { method: "POST", body: fd });
  const data = await res.json();

  if (!res.ok) {
    statusEl.textContent = "Error: " + (data.error || res.status);
    return;
  }

  outImg.src = "data:image/png;base64," + data.annotated_image_base64;

  // guardar resultados (importante antes de render para que el edit funcione)
  lastImageBase64 = data.annotated_image_base64;
  lastPoints = data.points || [];
  lastModelId = modelSelect.value;
  lastBaseName = baseName;

  renderTable(lastPoints);

  downloadImgBtn.disabled = false;
  downloadXlsxBtn.disabled = false;

  statusEl.textContent = "Listo ✅";
});


/* ===================== ZOOM + PAN (CLICK) ===================== */
const viewer = document.getElementById("viewer");
const resetViewBtn = document.getElementById("resetViewBtn");

let scale = 1;
let offsetX = 0;
let offsetY = 0;

let dragging = false;
let startX = 0;
let startY = 0;

function applyTransform() {
  outImg.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
}

function clampScale(s) {
  return Math.min(10, Math.max(0.05, s));
}

function fitToViewerCenter() {
  if (!outImg.naturalWidth || !outImg.naturalHeight) return;

  const vw = viewer.clientWidth;
  const vh = viewer.clientHeight;
  const iw = outImg.naturalWidth;
  const ih = outImg.naturalHeight;

  const s = Math.min(vw / iw, vh / ih);
  scale = clampScale(s);

  offsetX = (vw - iw * scale) / 2;
  offsetY = (vh - ih * scale) / 2;

  applyTransform();
}

function zoomAt(clientX, clientY, factor) {
  const rect = viewer.getBoundingClientRect();
  const vx = clientX - rect.left;
  const vy = clientY - rect.top;

  const ix = (vx - offsetX) / scale;
  const iy = (vy - offsetY) / scale;

  const newScale = clampScale(scale * factor);

  offsetX = vx - ix * newScale;
  offsetY = vy - iy * newScale;
  scale = newScale;

  applyTransform();
}


/* ===================== DESCARGAS ===================== */
function downloadBase64Image(base64Png, filename = "imagen_anotada.png") {
  const a = document.createElement("a");
  a.href = "data:image/png;base64," + base64Png;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

downloadImgBtn.addEventListener("click", () => {
  if (!lastImageBase64) return;
  const fname = `${lastBaseName || "imagen"} (anotada).png`;
  downloadBase64Image(lastImageBase64, fname);
});

downloadXlsxBtn.addEventListener("click", async () => {
  if (!lastPoints || lastPoints.length === 0) return;

  const res = await fetch("/export/excel", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      points: lastPoints,
      model_id: lastModelId
    }),
  });

  if (!res.ok) {
    alert("Error descargando Excel");
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${lastBaseName || "imagen"} (tabla).xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
});


/* ===================== INTERACCIONES VISOR ===================== */
viewer.addEventListener("click", (e) => {
  if (!outImg.src) return;
  const factor = e.shiftKey ? 1 / 1.25 : 1.25;
  zoomAt(e.clientX, e.clientY, factor);
});

viewer.addEventListener("mousedown", (e) => {
  dragging = true;
  startX = e.clientX - offsetX;
  startY = e.clientY - offsetY;
  viewer.style.cursor = "grabbing";
});

window.addEventListener("mousemove", (e) => {
  if (!dragging) return;
  offsetX = e.clientX - startX;
  offsetY = e.clientY - startY;
  applyTransform();
});

window.addEventListener("mouseup", () => {
  dragging = false;
  viewer.style.cursor = "grab";
});

viewer.addEventListener("wheel", (e) => {
  e.preventDefault();
  const factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
  zoomAt(e.clientX, e.clientY, factor);
}, { passive: false });

resetViewBtn.addEventListener("click", () => {
  fitToViewerCenter();
});

outImg.onload = () => {
  fitToViewerCenter();
};

window.addEventListener("resize", () => {
  if (outImg.src) fitToViewerCenter();
});
</script>

</body>
</html>
