<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coral App – Marcado de Puntos</title>

<style>
body { font-family: Arial, sans-serif; margin: 18px; background:#fafafa; }
h2, h3 { margin-top: 0; }

.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 14px;
}

.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

button {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #f3f3f3;
  cursor: pointer;
}

button:hover { background: #e9e9e9; }

input[type="number"] { width: 90px; }

.row {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  flex-wrap: wrap;
}

table {
  border-collapse: collapse;
  width: 420px;
  max-width: 100%;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px 8px;
}

th {
  background: #f0f0f0;
  text-align: left;
}

/* VISOR GRANDE */
#viewer {
  width: min(1200px, 98vw);
  height: 75vh;
  border: 1px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  background: #f7f7f7;
  cursor: grab;
}

#viewer img {
  position: absolute;
  left: 0;
  top: 0;
  transform-origin: 0 0;
  user-select: none;
  -webkit-user-drag: none;
}

#status {
  margin-top: 8px;
  font-size: 14px;
  font-weight: bold;
}

.help-text {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
}
</style>
</head>

<body>
<h2>Coral – Sistema de marcado de puntos</h2>

<div class="card">
  <h3>Procesar imagen</h3>

  <form id="imageForm" class="toolbar">
    <input type="file" id="imageFile" accept="image/*" required />

    <label>Modelo:</label>
    <select id="modelSelect"></select>

    <label>N puntos:</label>
    <input type="number" id="nPoints" value="100" min="1" max="5000" />

    <button type="submit">Procesar</button>
  </form>

  <div id="status"></div>
</div>

<div class="row">

  <div class="card">
    <h3>Imagen anotada</h3>

    <div class="toolbar" style="margin-bottom:8px;">
      <button id="resetViewBtn" type="button">Reiniciar vista</button>
      <div class="help-text" style="margin:0;">
        Click: zoom + | Shift+Click: zoom - | Arrastrar: mover | Rueda: zoom
      </div>
    </div>

    <div id="viewer">
      <img id="outImg" />
    </div>
  </div>

  <div class="card">
    <h3>Tabla de puntos</h3>
    <div id="table"></div>
  </div>

</div>

<script>
/* ===================== MODELOS ===================== */
const modelSelect = document.getElementById("modelSelect");

async function loadModels() {
  modelSelect.innerHTML = "";
  const res = await fetch("/models");
  const data = await res.json();

  if (!data.models || data.models.length === 0) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(Sin modelos)";
    modelSelect.appendChild(opt);
    return;
  }

  for (const m of data.models) {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.model_name || m.id;
    modelSelect.appendChild(opt);
  }
}
window.addEventListener("DOMContentLoaded", loadModels);


/* ===================== TABLA ===================== */
const tableDiv = document.getElementById("table");

function renderTable(points) {
  let html = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>x</th>
          <th>y</th>
          <th>clase</th>
          <th>conf</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const p of points) {
    html += `
      <tr>
        <td>${p.label ?? ""}</td>
        <td>${p.x}</td>
        <td>${p.y}</td>
        <td>${p.pred_label ?? ""}</td>
        <td>${p.confidence != null ? p.confidence.toFixed(3) : ""}</td>
      </tr>
    `;
  }

  html += "</tbody></table>";
  tableDiv.innerHTML = html;
}


/* ===================== PROCESAR ===================== */
const imageForm = document.getElementById("imageForm");
const statusEl = document.getElementById("status");
const outImg = document.getElementById("outImg");

imageForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const fd = new FormData();
  fd.append("file", document.getElementById("imageFile").files[0]);
  fd.append("n", document.getElementById("nPoints").value);
  fd.append("model_id", modelSelect.value);

  statusEl.textContent = "Procesando imagen...";
  tableDiv.innerHTML = "";
  outImg.src = "";

  const res = await fetch("/process", { method: "POST", body: fd });
  const data = await res.json();

  if (!res.ok) {
    statusEl.textContent = "Error: " + (data.error || res.status);
    return;
  }

  outImg.src = data.annotated_image_url + "?t=" + Date.now();
  renderTable(data.points);
  statusEl.textContent = "Listo ✅";
});


/* ===================== ZOOM + PAN (CLICK) ===================== */
const viewer = document.getElementById("viewer");
const resetViewBtn = document.getElementById("resetViewBtn");

let scale = 1;
let offsetX = 0;
let offsetY = 0;

let dragging = false;
let startX = 0;
let startY = 0;

function applyTransform() {
  outImg.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
}

function clampScale(s) {
  return Math.min(10, Math.max(0.05, s));
}

/* ✅ Fit + centrar: que la imagen quepa en el viewer */
function fitToViewerCenter() {
  if (!outImg.naturalWidth || !outImg.naturalHeight) return;

  const vw = viewer.clientWidth;
  const vh = viewer.clientHeight;
  const iw = outImg.naturalWidth;
  const ih = outImg.naturalHeight;

  // escala para que quepa completa
  const s = Math.min(vw / iw, vh / ih);
  scale = clampScale(s);

  // centrar
  offsetX = (vw - iw * scale) / 2;
  offsetY = (vh - ih * scale) / 2;

  applyTransform();
}

function zoomAt(clientX, clientY, factor) {
  const rect = viewer.getBoundingClientRect();
  const vx = clientX - rect.left;
  const vy = clientY - rect.top;

  const ix = (vx - offsetX) / scale;
  const iy = (vy - offsetY) / scale;

  const newScale = clampScale(scale * factor);

  offsetX = vx - ix * newScale;
  offsetY = vy - iy * newScale;
  scale = newScale;

  applyTransform();
}

/* Click zoom in, Shift+Click zoom out */
viewer.addEventListener("click", (e) => {
  if (!outImg.src) return;
  const factor = e.shiftKey ? 1 / 1.25 : 1.25;
  zoomAt(e.clientX, e.clientY, factor);
});

/* Arrastrar */
viewer.addEventListener("mousedown", (e) => {
  dragging = true;
  startX = e.clientX - offsetX;
  startY = e.clientY - offsetY;
  viewer.style.cursor = "grabbing";
});

window.addEventListener("mousemove", (e) => {
  if (!dragging) return;
  offsetX = e.clientX - startX;
  offsetY = e.clientY - startY;
  applyTransform();
});

window.addEventListener("mouseup", () => {
  dragging = false;
  viewer.style.cursor = "grab";
});

/* Wheel opcional */
viewer.addEventListener("wheel", (e) => {
  e.preventDefault();
  const factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
  zoomAt(e.clientX, e.clientY, factor);
}, { passive: false });

/* ✅ Botón reset */
resetViewBtn.addEventListener("click", () => {
  fitToViewerCenter();
});

/* ✅ Al cargar la imagen: ajustar y centrar */
outImg.onload = () => {
  fitToViewerCenter();
};

/* ✅ Si cambia tamaño de ventana: re-centrar (opcional) */
window.addEventListener("resize", () => {
  if (outImg.src) fitToViewerCenter();
});
</script>

</body>
</html>
